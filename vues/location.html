
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<div class="container forecasts-box">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content text-center">
            <div class="modal-body">
                <button class="btn-close" data-bs-dismiss="modal"></button>
                <div class="row text-center">
                    <h3 class="module_title location_parameter_name">
                    </h3>
                    <h3 class="sub-title site-name11">Location: <span class="current_location_name"></span>
                    </h3>
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home"
                                aria-selected="true">Observations</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile"
                                aria-selected="false">Forecasts</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill"
                                data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact"
                                aria-selected="false">Intervals</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                            aria-labelledby="pills-home-tab">
                            <div class="col-md-12">
                                <div class="row align-items-center counter-wrapper gy-4 gy-md-0">
                                    <div class="col-md-4">
                                        <h5 class="current_param"></h5>
                                            <div class="">
                                                
                                                <div class="obs_value_container">
                                                    <h1 class="observation_value current_observation_value">
                                                    </h1>
                                                    <span class="observation_unit  current_observation_unit_span">ppm</span>
                                                </div>
                                                
                                            </div>
                                    </div>

                                    <div id="observations_only"></div>
                                    <p class="caption">
                                        Source: <a href="https://openaq.org/#/">OpenAQ</a>
                                    </p>
                                </div>
                            </div>


                        </div>
                        <div class="tab-pane fade" id="pills-profile" role="tabpanel"
                            aria-labelledby="pills-profile-tab">
                            <div class="row">
                                <div class="col-lg-12 position-relative">
                                    <div id='myDiv' class='lf_full_plot'></div>
                                    <p class="caption">
                                        Source: NASA's GMAO GEOS-CF
                                    </p>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-xl-5 mx-auto">
                                    <h2 class="display-4 mb-3 text-center">Train your own model for this location</h2>
                                    <a href="#" class="btn btn-primary rounded-pill train_model">Train Model</a>
                                </div>
                                <!-- /column -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-contact" role="tabpanel"
                            aria-labelledby="pills-contact-tab">
                            <div class="col-lg-12">
                                <h3 class="sub-title">Confidence intervals</h3>
                                <div id='intervals' class='lf_full_plot'></div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <script src='parametres/plotly-2.12.1.min.js'></script>
    
    <script>
   
	$('.current_observation_unit_span').html("test");

    d3.json("./demo-forecasts/forecast_latest_FR40008_no2.json", function(data) {
        console.log(data);
        function csvToArray(str, delimiter = ",") {
        const headers = str.slice(0, str.indexOf("\n")).split(delimiter);
        const rows = str.slice(str.indexOf("\n") + 1).split("\n");
        const arr = rows.map(function(row) {
            const values = row.split(delimiter);
            const el = headers.reduce(function(object, header, index) {
                object[header] = values[index];
                return object;
            }, {});
            return el;
        });

        return arr;
    }
    var pure_data = csvToArray(data.latest_forecast.data);


    var date_time = $(pure_data).map(function() {
        return this.forecast_datetime;
    }).get()

    var localized = $(pure_data).map(function() {
        return this.localized_no2;
    }).get()

    var uncorrected = $(pure_data).map(function() {
        return this.uncorrected_no2;
    }).get()

    var observation = $(pure_data).map(function() {
        return this.observation;
    }).get()

    console.log(pure_data);
        


    var trace1 = {
        type: "scatter",
        mode: "lines",
        x: date_time,
        y: localized,
        line: {
            color: 'green'
        },
        name: 'Localized_'+param
    }

    var trace2 = {
        type: "scatter",
        mode: "lines",
        x: date_time,
        y: uncorrected,
        line: {
            color: 'red'
        },
        name: 'Uncorrected_'+param
    }

    var trace3 = {
        type: "scatter",
        mode: "lines",
        x: date_time,
        y: observation,
        line: {
            color: 'blue'
        },
        name: 'Observation'
    }


    var pred = [trace1, trace2, trace3];

    var pred_obs = [trace1];

    var layout = {
        // title: 'Bias Corrected Model',
        font: {
            family: 'Helvetica, sans-serif',
            size: 18,
            color: '#7f7f7f'
        },
        xaxis: {
            // range: ['2021-06-10', '2021-06-30'],
            type: 'date'
        },

        yaxis: {
            autorange: true,
            type: 'linear',

        },
        shapes: [{
            type: 'line',
            x0: String(data.latest_forecast.forecast_initialization_date),
            y0: 0,
            x1: String(data.latest_forecast.forecast_initialization_date),
            yref: 'paper',
            y1: 1,
            line: {
                color: 'green',
                width: 2,
                dash: 'dot'
            }
        }]
    };

    Plotly.newPlot('myDiv', pred, layout);
    Plotly.newPlot('observations_only', pred_obs, layout);
        });



         d3.csv("./vues/10812-intervals.csv", function(err, rows) {

        function unpack(rows, key) {
            return rows.map(function(row) {
                return row[key];
            });
        }

        console.log('unpacked!');
        console.log(unpack(rows, 'timestamp'));


        var trace1 = {
            type: "scatter",
            mode: "lines",
            x: unpack(rows, 'timestamp'),
            y: unpack(rows, 'value'),
            line: {
                color: 'red'
            },
            name: 'Observation',
            type: "scatter",
            fill: "tonexty",
            fillcolor: "white",
        }

        var trace2 = {
            type: "scatter",
            mode: "lines",
            x: unpack(rows, 'timestamp'),
            y: unpack(rows, 'upper'),
            line: {
                color: 'blue'
            },
            name: 'Upper Quantile',
            type: "scatter",
            fill: "tonexty",
            fillcolor: "rgba(68, 68, 68, 0.3)",
        }

        var trace3 = {
            type: "scatter",
            mode: "lines",
            x: unpack(rows, 'timestamp'),
            y: unpack(rows, 'lower'),
            line: {
                color: 'green'
            },
            name: 'Lower Quantile',
            type: "scatter",
            fill: "tonexty",
            fillcolor: "rgba(68, 68, 68, 0.3)",
        }

        var pred = [trace1];

        var intervals = [trace1, trace2, trace3];

        var layout = {
            // title: 'Bias Corrected Model',
            font: {
                family: 'Helvetica, sans-serif',
                size: 18,
                color: '#7f7f7f'
            },
            xaxis: {
                // range: ['2021-06-10', '2021-06-30'],
                type: 'date'
            },

            yaxis: {
                autorange: true,
                range: [86.8700008333, 138.870004167],
                type: 'linear',

            }
        };

        Plotly.newPlot('intervals', intervals, layout);
        });

    
    </script>